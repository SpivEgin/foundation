<!doctype html>
<html>
<head lang="en">
    <meta charset="utf-8">
    <title>Discount Editor</title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.2/angular.min.js"></script>

    <script type="text/javascript">

        var module = angular.module("DiscountEditor", []);

        module.directive("template", ["$compile", function ($compile) {
            var template = {
                restrict: 'EA',
                scope: true,
                compile: function (element, attributes) {

                    /* initializing directive related variables */
                    var templateIsTag = false;
                    var templateName = null;
                    var templateAttributes = {};
                    var watchExpression = null;

                    if (element[0].tagName.toLowerCase() == this.name.toLowerCase()) {
                        templateIsTag = true;
                    }

                    /* template attributes filtering */
                    if (templateIsTag) {
                        /* case 1: directive usage as a tag - all attributes related */
                        for (var tagAttribute in attributes.$attr) {
                            if (! attributes.$attr.hasOwnProperty(tagAttribute)) { continue; }

                            var tagAttrName = tagAttribute.replace(/^(data-|x-)/, "").toLowerCase();
                            templateAttributes[tagAttrName] = attributes[tagAttribute];
                        }

                    } else {
                        /* case 2: directive usage as an attribute - attribute prefix filtering*/
                        var templatePrefix = "tp";
                        for (var loop = true; loop; loop = !loop) {
                            for (var attribute in attributes.$attr) {
                                if (!attributes.$attr.hasOwnProperty(attribute)) { continue; }

                                var attr = attribute.replace(/^(data-|x-)/, "").toLowerCase();

                                /* non default prefix specified, we should repeat scan for that case (as attributes order is not strict) */
                                if (attr == "template" && attributes[attribute] != "") {
                                    templatePrefix = attributes[attribute];

                                    delete attributes.$attr[attribute];
                                    element.removeAttr(attribute);

                                    loop = false;
                                }

                                /* grabbing template related attributes and removing them from element */
                                if (attr.startsWith(templatePrefix)) {
                                    attr = attr.slice(templatePrefix.length);

                                    templateAttributes[attr] = attributes[attribute];
                                    delete attributes.$attr[attribute];
                                    element.removeAttr(attribute);
                                }
                            }
                        }
                    }

                    /* template "set" operation specified */
                    if ("set" in templateAttributes) {
                        var saveName = templateAttributes["set"];
                        delete templateAttributes["set"];

                        if (typeof angular.templates == 'undefined') {
                            angular.templates = {};
                        }

                        /* angular scope and $compile operations requires top element */
                        if (templateIsTag) {
                            angular.templates[saveName] = "<span>" + element.html() + "</span>";
                        } else {
                            angular.templates[saveName] = element[0].outerHTML;
                        }
                    }

                    /* template "get" operation specified */
                    if ("get" in templateAttributes) {
                        templateName = templateAttributes["get"];
                        delete templateAttributes["get"]
                    } else {
                        templateName = null;
                    }

                    /* template "get" operation specified */
                    if ("watch" in templateAttributes) {
                        watchExpression = templateAttributes["watch"];
                        delete templateAttributes["watch"]
                    } else {
                        watchExpression = null;
                    }

                    /* directive's "link" function */
                    return function (scope, element, attributes) {

                        var result = '';
                        if (templateName != null && templateName != '') {
                            /* looking for a stored template HTML */
                            var templateHTML = '';
                            if (typeof angular.templates != 'undefined' &&
                                    typeof angular.templates[templateName] != 'undefined') {

                                templateHTML = angular.templates[templateName];
                            }

                            /* taking subject to which new scope will be applied */
                            var templateElement = angular.element();
                            if (templateIsTag) {
                                if (templateHTML != '') {
                                    templateElement = angular.element(templateHTML)
                                }
                            } else {
                                templateElement = element.append(templateHTML);
                            }

                            /* making new scope */
                            var templateScope = scope.$new(false, scope);
                            for (var attribute in templateAttributes) {
                                var value = templateAttributes[attribute];
                                try {
                                    value = value.replace(/^\s*\{\{\s*/, "").replace(/\s*\}\}\s*$/, "");
                                    value = scope.$eval(value);
                                } catch (e) {
                                    // console.log(e);
                                }
                                // scope[attribute] = value;
                                templateScope[attribute] = value;
                            }

                            /* applying new scope to the subject */
                            result = $compile(templateElement)(templateScope);

                            if (watchExpression != null) {
                                templateScope.$watch(function(scope){
                                    console.log("111");
                                    return new Date().getSeconds();
                                }, function(value) {
                                    console.log("222");
                                    result = $compile(templateElement)(templateScope);
                                    element.replaceWith(result);
                                    element = result;
                                });
                            }
                        }
                        element.replaceWith(result);
                        element = result;
                    }
                }
            };
            return template;
        }]);

        var utils = {
            pathToArray: function (path, separator) {
                path = path || [];
                separator = separator || "/";

                if (Array.isArray(path)) {
                    return path;
                }

                if (typeof path != "string") {
                    return path;
                }

                return path.replace(new RegExp("^[" + separator + "]+"), "")
                        .replace(new RegExp("[" + separator + "]+$"), "")
                        .split(separator);
            },

            pathGet: function (subject, path, lastone) {
                var result = [];

                /* params validation */
                if (typeof subject != "object") {
                    return result;
                }

                path = this.pathToArray(path);
                if (path.length == 0) {
                    return result;
                }

                lastone = lastone || false;

                /* path extraction */
                if (path[0] in subject) {
                    result.push(subject[path[0]]);
                } else {
                    return result;
                }

                if (path.length > 1) {
                    result = result.concat(pathGet(subject[path[0]], path.slice(1), false));
                }

                /* single value result */
                if (lastone) {
                    if (result.length > 0) {
                        return result[result.length-1];
                    }
                    return undefined;
                }

                return result;
            },

            pathSet: function (subject, path, value) {
                path = this.pathToArray(path);
                var values = pathGet(subject, path, false);

                for(var i = 0; i < path.length; i++) {

                    if (i == path.length-1) {
                        values[i] = value;
                    } else if (values[i] == undefined || typeof values[i] != "object") {
                        values[i] = {};
                    } else {
                        continue;
                    }

                    if (i > 0) {
                        subject = values[i-1];
                    }
                    subject[path[i]] = values[i];
                }
            },

            mergeObject: function(sourceObject, destinationObject) {
                for (var key in sourceObject) {
                    if (sourceObject.hasOwnProperty(key)) {
                        destinationObject[key] = sourceObject[key];
                    }
                }
            }
        };

        module.service("$composer", ["$http", "$q", function ($http, $q) {
            var $composer = {
                API_SERVER_URL: "http://localhost:3000",

                ARRAY_PREFIX: "[]",

                UNIT_PREFIX: "*",
                UNIT_ARG_PREFIX: "@",
                UNIT_OUT_PREFIX: "#",

                basic: ["string", "int", "float", "boolean", "array", "object"],
                types: {},
                units: {},
                aliases: {},

                isBasic: function (typeName) {
                    return $composer.basic.indexOf(typeName) > 0;
                },

                isUnit: function (typeName) {
                    return typeName.indexOf($composer.UNIT_PREFIX) == 0;
                },

                isAny: function (typeName) {
                    return typeName == "any" || typeName == "*";
                },

                isArray: function (typeName) {
                    typeName = typeName.toString();
                    return typeName.indexOf($composer.ARRAY_PREFIX) == 0 || typeName == "array";
                },

                arrayType: function (typeName) {
                    typeName = typeName.toString();
                    return typeName.slice($composer.ARRAY_PREFIX.length);
                },

                alias: function(typeName) {
                    if (typeName in $composer.alias) {
                        return $composer.alias[typeName];
                    }
                    return typeName;
                },

                type: function (typeName) {
                    if (typeName in $composer.types) {
                        return $q.when($composer.types[typeName]);
                    }

                    return $http({
                        url: $composer.API_SERVER_URL + "/composer/type/" + typeName,
                        method: "GET"
                    }).then(function (response) {

                        if (response.data.error != null) {
                            alert(response + ":" + response.data.error.message);
                            return null;
                        }

                        if (typeName in response.data.result) {
                            $composer.types[typeName] = response.data.result[typeName];
                            return $composer.types[typeName];
                        }

                        return null;
                    });
                },

                unit: function (unitName) {
                    if (unitName in $composer.units) {
                        return $composer.units[unitName];
                    }

                    return $http({
                        url: $composer.API_SERVER_URL + "composer/unit/" + unitName,
                        method: "GET"
                    }).then(function (response) {
                        if (response.data.error != null) {
                            alert(response.data.error.message);
                            return null;
                        }
                        $composer.units[unitName] = response.data.result;
                    });
                }
            };
            return $composer;
        }]);

        module.controller("ComposeElement", ["$scope", "$q", "$composer", function ($scope, $q, $composer) {

            /*var makeEditor = function(element, callback) {
                // editor components
                var editor = angular.element("<input class='compose-editor' type='text' />");
                var confirm = angular.element("<i class='compose-editor confirm glyphicon glyphicon-ok'>&nbsp;</i>");
                var cancel = angular.element("<i class='compose-editor cancel glyphicon glyphicon-remove'>&nbsp;</i>");
                var wrapper = angular.element("<span class='compose-element-key-edit'>");
                wrapper.append(cancel).append(editor).append("&nbsp;&nbsp;").append(confirm);

                editor[0].value = element.html();

                // event handlers
                var exitFunc = function() {
                    wrapper.remove();
                    element.removeClass("hide");
                };

                var saveFunc = function() {
                    if (typeof callback == "function") {
                        callback(editor[0].value);
                    }
                };

                editor.on("keypress", function(e){ if(e.keyCode == 13) {
                    saveFunc();
                    exitFunc();
                }});

                confirm.on("click", saveFunc);
                confirm.on("click", exitFunc);
                cancel.on("click", exitFunc);

                // editor display
                element.addClass("hide");
                element.after(wrapper);
                editor[0].focus();
            };*/
            var ComposeElement = {
                self: $scope,      /* scope reference */

                isReady: false,     /* flag indicates that element is ready for render */
                isBasic: true,      /* flag indicates that element is basic JS type */
                isUnit: false,      /* flag indicates that element is Unit and not Type */

                value: null,        /* value of current element */
                type: undefined,    /* element type (Composer type) */
                desc: "",           /* type description (Composer type) */
                label: "",          /* type label (Composer type) */

                path: [],           /* path to current element within json */
                root: this,         /* reference to root ComposeElement (scope) */
                json: {},           /* reference to root value (object) */
                tree: undefined,    /* copy of json but with ComposeElement values (only in root) */

                info: {},           /* sub-element types information (Composer types) */
                children: {},       /* prepared input parameters for sub-elements */


                /**
                 * Element initializer
                 *
                 * @param input object - init params
                 */
                init: function(input)
                {
                    this.isReady = false;

                    /* extracting input parameters (if specified) */
                    if (input != undefined && typeof input == "object") {
                        ["value", "path", "json", "root", "type", "label"].map(function(field){
                            if (field in input) {
                                this[field] = input[field];
                            }
                        })
                    }

                    /* validations */
                    this.path = utils.pathToArray(this.path);

                    if (typeof this.type != "string" || this.type == "") {
                        this.type = typeof this.value;
                    }


                    /* navigation references update */
                    if (this.root == this) {
                        this.json = this.value;
                        this.tree = {};
                    } else {
                        // root scope tree update with self reference
                        var treeObject = this.root.tree;
                        for (var pathIdx=0; pathIdx < this.path.length; pathIdx++) {
                            var pathKey = this.path[pathIdx];

                            if (typeof treeObject[pathKey] != "object") {
                                treeObject[pathKey] = {};
                            }

                            if (pathIdx != this.path.length-1) {
                                treeObject = treeObject[pathKey];
                            } else {
                                treeObject[pathKey] = {".": this};
                            }
                        }
                    }


                    /* composer type resolution */
                    if (!$composer.isBasic(this.type)) {
                        this.isBasic = false;
                        if ($composer.isUnit(this.type)) {
                            this.isUnit = true;
                            this.info = $composer.unit(this.type);
                        } else {
                            this.info = $composer.type(this.type);
                        }
                    }

                    $q.when(this.info).then(function (info) {
                        this.info = info;

                        for (var item in this.value) {
                            if (!this.value.hasOwnProperty(item)) {
                                continue;
                            }

                            if (this.info[item] == undefined) {
                                continue;
                            }

                            var itemPath = this.path.slice();
                            itemPath.push(item);

                            this.children[item] = {
                                path: itemPath,
                                root: this.root,
                                json: this.json,

                                value: this.value[item],
                                label: this.info[item].label,
                                type:  this.info[item].type,
                                desc:  this.info[item].desc
                            };
                        }
                        this.isReady = true;
                    });
                },

                jsType: function() {
                    return typeof this.value;
                },

                collapse: function(event) {
                    var element = angular.element(event.target);
                    element.toggleClass('glyphicon-triangle-right glyphicon-triangle-bottom');

                    for (var i = 0; i < 10; i++) {
                        if (element.hasClass('compose-element')) {
                            element.toggleClass('minified');
                            break;
                        }
                        element = element.parent();
                    }
                },

                editKey: function(event, data) {
                    var element = angular.element(event.target);
                    makeEditor(element, function(newValue) {
                        data.label = newValue;
                        data.$apply();
                    });
                },

                editType: function(event, data) {
                    var element = angular.element(event.target);
                    makeEditor(element, function(newValue) {
                        data.type = newValue;
                        data.$apply();
                    });
                },

                editItem: function(event, self) {
                    alert("there");
                    self.edit=true;
                },

                addItem: function(event, self) {
                    // var element = angular.element(event.target);
                    // data.json.visitor.first_name = "Evpat";
                    // data.json.visitor.email="123@ukr.net";
                    // pathValues(data.root.tree, "visitor").slice(-1)[0]["."].init();
                    util.pathGet(self.json, self.path, true)["email"] = "ll";
                    self.init();
                    // pathValues(data.root.tree, "visitor").slice(-1)[0]["."].init();
                    // data.root.$apply();
                    // data.root.children.visitor.scope.$digest();
                    // setTimeout(function() { data.parent.$apply(); }, 1000);
                },

                jsonValue: function(key) {
                    return utils.pathGet(this.json, this.path.concat(key), true);
                }
            };

            ComposeElement.init($scope);
            utils.mergeObject(ComposeElement, $scope);
        }]);


        module.controller("ComposeEditor", ["$scope", function ($scope) {
            var ComposeEditor = {
                json: {'visitor': 
                        {
                            'first_name': 'test', 
                            'last_name': '123'
                        }
                      },
                type: "DiscountRule"
            };

            utils.mergeObject(ComposeEditor, $scope);
        }]);
    </script>

    <style>
        .container {
            padding: 0px 5px 0px 0px;
            background-color: #f3f6fa;
            background-image: repeating-linear-gradient(180deg, #d9edf7, #d9edf7 30px, #f5f5f5 30px, white 60px);
        }

        .compose-element {
            list-style: none;
            margin: 0;
            padding-left: 20px;
        }

        .compose-item-line {
            height: 30px;
            line-height: 30px;
        }

        .compose-item-line button {
            float: right;
            box-sizing: border-box;
            height: 30px;
            line-height: 26px;
            border-color: transparent;
            background-color: transparent;
        }

        .compose-item-line input {
            width: 100px;
            border: none;
            display: inline;
            height: 30px;
            padding: 5px;
            background-color: transparent;
        }
    </style>
</head>

<body ng-app="DiscountEditor">

<!-- template tree item -->
<ul class="compose-element" template="tpl" tpl-set="compose-element" ng-controller="ComposeElement">
    <li class="compose-item">
        <div class="compose-item-line" ng-if="isReady">

            <span class="compose-item-icon" ng-switch="children.length > 0">
                <i class="glyphicon glyphicon-triangle-bottom"
                   ng-switch-when="true"
                   ng-click="collapse($event)"></i>

                <i class="glyphicon" ng-switch-default>&nbsp;</i>
            </span>

            <span class="compose-item-label">
                <b ng-click="editKey($event, scope)">{{ !label ? '""' : label }}</b>
                (<a ng-click="editType($event, scope)">{{ !type ? '""' : type }}</a>):
            </span>

            <span class="compose-item-editor" ng-switch="jsType()">
                <input type="text"
                       ng-switch-when="string"
                       ng-model="value"
                       ng-change="edit(value)"/>

                <input type="number"
                       step="0.1"
                       ng-switch-when="number"
                       ng-model="value"
                       ng-change="edit(value)"/>

                <input type="checkbox"
                       ng-switch-when="boolean"
                       ng-model="value"
                       ng-change="edit(value)"/>
            </span>

            <button ng-click="editItem($event, scope)">
                <i class="glyphicon glyphicon-edit"></i>
            </button>

            <button ng-if="parent != null" ng-click="removeItem($event, scope)">
                <i class="glyphicon glyphicon-trash"></i>
            </button>

            <button ng-if="info" ng-click="addItem($event, scope)">
                <i class="glyphicon glyphicon-plus"></i>
            </button>

            <button ng-if="hasUnits" ng-click="addUnit($event, scope)">
                <i class="glyphicon glyphicon-indent-left"></i>
            </button>
        </div>

        <div class="compose-item-line" ng-if="edit">
            <select>
                <option value="123">123</option>
            </select>
        </div>

        <span ng-repeat="(key, val) in children track by jsonValue(key)">
            <template get="compose-element" data="val"></template>
        </span>
    </li>
</ul>

<div class="container" ng-controller="ComposeEditor">
    <template get="compose-element" value="json" type="type"></template>
</div>

</body>
</html>