<!doctype html>
<html>
<head lang="en">
    <meta charset="utf-8">
    <title>Discount Editor</title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.2/angular.min.js"></script>

    <script type="text/javascript">

        var pathToArray = function (path, separator) {
            path = path || [];
            separator = separator || "/";

            if (Array.isArray(path)) {
                return path;
            }

            if (typeof path != "string") {
                return path;
            }

            return path.replace(new RegExp("^[" + separator + "]+"), "")
                    .replace(new RegExp("[" + separator + "]+$"), "")
                    .split(separator);
        };

        var pathValues = function (subject, path) {
            var result = arguments[2] || [];

            if (typeof subject != "object") {
                return result;
            }

            path = pathToArray(path);
            if (path.length == 0) {
                return result;
            }

            if (path[0] in subject) {
                result.push(subject[path[0]]);
            } else {
                return result;
            }

            if (path.length > 1) {
                return pathValues(subject[path[0]], path.slice(1), result);
            }

            return result;
        };

        var pathUpdate = function (subject, path, value) {
            path = pathToArray(path);
            var values = pathValues(subject, path);

            for(var i = 0; i < path.length; i++) {

                if (i == path.length-1) {
                    values[i] = value;
                } else if (values[i] == undefined || typeof values[i] != "object") {
                    values[i] = {};
                } else {
                    continue;
                }

                if (i > 0) {
                    subject = values[i-1];
                }
                subject[path[i]] = values[i];
            }
        };

        var module = angular.module("DiscountEditor", []);

        module.directive("template", ["$compile", function ($compile) {
            var template = {
                restrict: 'EA',
                scope: true,
                compile: function (element, attributes) {

                    /* initializing directive related variables */
                    var templateIsTag = false;
                    var templateName = null;
                    var templateAttributes = {};
                    var watchExpression = null;

                    if (element[0].tagName.toLowerCase() == this.name.toLowerCase()) {
                        templateIsTag = true;
                    }

                    /* template attributes filtering */
                    if (templateIsTag) {
                        /* case 1: directive usage as a tag - all attributes related */
                        for (var tagAttribute in attributes.$attr) {
                            if (! attributes.$attr.hasOwnProperty(tagAttribute)) { continue; }

                            var tagAttrName = tagAttribute.replace(/^(data-|x-)/, "").toLowerCase();
                            templateAttributes[tagAttrName] = attributes[tagAttribute];
                        }

                    } else {
                        /* case 2: directive usage as an attribute - attribute prefix filtering*/
                        var templatePrefix = "tp";
                        for (var loop = true; loop; loop = !loop) {
                            for (var attribute in attributes.$attr) {
                                if (!attributes.$attr.hasOwnProperty(attribute)) { continue; }

                                var attr = attribute.replace(/^(data-|x-)/, "").toLowerCase();

                                /* non default prefix specified, we should repeat scan for that case (as attributes order is not strict) */
                                if (attr == "template" && attributes[attribute] != "") {
                                    templatePrefix = attributes[attribute];

                                    delete attributes.$attr[attribute];
                                    element.removeAttr(attribute);

                                    loop = false;
                                }

                                /* grabbing template related attributes and removing them from element */
                                if (attr.startsWith(templatePrefix)) {
                                    attr = attr.slice(templatePrefix.length);

                                    templateAttributes[attr] = attributes[attribute];
                                    delete attributes.$attr[attribute];
                                    element.removeAttr(attribute);
                                }
                            }
                        }
                    }

                    /* template "set" operation specified */
                    if ("set" in templateAttributes) {
                        var saveName = templateAttributes["set"];
                        delete templateAttributes["set"];

                        if (typeof angular.templates == 'undefined') {
                            angular.templates = {};
                        }

                        /* angular scope and $compile operations requires top element */
                        if (templateIsTag) {
                            angular.templates[saveName] = "<span>" + element.html() + "</span>";
                        } else {
                            angular.templates[saveName] = element[0].outerHTML;
                        }
                    }

                    /* template "get" operation specified */
                    if ("get" in templateAttributes) {
                        templateName = templateAttributes["get"];
                        delete templateAttributes["get"]
                    } else {
                        templateName = null;
                    }

                    /* template "get" operation specified */
                    if ("watch" in templateAttributes) {
                        watchExpression = templateAttributes["watch"];
                        delete templateAttributes["watch"]
                    } else {
                        watchExpression = null;
                    }

                    /* directive's "link" function */
                    return function (scope, element, attributes) {

                        var result = '';
                        if (templateName != null && templateName != '') {
                            /* looking for a stored template HTML */
                            var templateHTML = '';
                            if (typeof angular.templates != 'undefined' &&
                                    typeof angular.templates[templateName] != 'undefined') {

                                templateHTML = angular.templates[templateName];
                            }

                            /* taking subject to which new scope will be applied */
                            var templateElement = angular.element();
                            if (templateIsTag) {
                                if (templateHTML != '') {
                                    templateElement = angular.element(templateHTML)
                                }
                            } else {
                                templateElement = element.append(templateHTML);
                            }

                            /* making new scope */
                            var templateScope = scope.$new(false, scope);
                            for (var attribute in templateAttributes) {
                                var value = templateAttributes[attribute];
                                try {
                                    value = value.replace(/^\s*\{\{\s*/, "").replace(/\s*\}\}\s*$/, "");
                                    value = scope.$eval(value);
                                } catch (e) {
                                    // console.log(e);
                                }
                                // scope[attribute] = value;
                                templateScope[attribute] = value;
                            }

                            /* applying new scope to the subject */
                            result = $compile(templateElement)(templateScope);

                            if (watchExpression != null) {
                                templateScope.$watch(function(scope){
                                    console.log("111");
                                    return new Date().getSeconds();
                                }, function(value) {
                                    console.log("222");
                                    result = $compile(templateElement)(templateScope);
                                    element.replaceWith(result);
                                    element = result;
                                });
                            }
                        }
                        element.replaceWith(result);
                        element = result;
                    }
                }
            };
            return template;
        }]);

        module.service("$composer", ["$http", "$q", function ($http, $q) {
            var $composer = {
                API_SERVER_URL: "http://localhost:3000",

                ARRAY_PREFIX: "[]",

                UNIT_PREFIX: "*",
                UNIT_ARG_PREFIX: "@",
                UNIT_OUT_PREFIX: "#",

                basic: ["string", "int", "float", "boolean", "array", "object"],
                types: {},
                units: {},
                aliases: {},

                isBasic: function (typeName) {
                    return $composer.basic.indexOf(typeName) > 0;
                },

                isUnit: function (typeName) {
                    return typeName.indexOf($composer.UNIT_PREFIX) == 0;
                },

                isAny: function (typeName) {
                    return typeName == "any" || typeName == "*";
                },

                isArray: function (typeName) {
                    typeName = typeName.toString();
                    return typeName.indexOf($composer.ARRAY_PREFIX) == 0 || typeName == "array";
                },

                arrayType: function (typeName) {
                    typeName = typeName.toString();
                    return typeName.slice($composer.ARRAY_PREFIX.length);
                },

                alias: function(typeName) {
                    if (typeName in $composer.alias) {
                        return $composer.alias[typeName];
                    }
                    return typeName;
                },

                type: function (typeName) {
                    if (typeName in $composer.types) {
                        return $q.when($composer.types[typeName]);
                    }

                    return $http({
                        url: $composer.API_SERVER_URL + "/composer/type/" + typeName,
                        method: "GET"
                    }).then(function (response) {

                        if (response.data.error != null) {
                            alert(response + ":" + response.data.error.message);
                            return null;
                        }

                        if (typeName in response.data.result) {
                            $composer.types[typeName] = response.data.result[typeName];
                            return $composer.types[typeName];
                        }

                        return null;
                    });
                },

                unit: function (unitName) {
                    if (unitName in $composer.units) {
                        return $composer.units[unitName];
                    }

                    return $http({
                        url: $composer.API_SERVER_URL + "composer/unit/" + unitName,
                        method: "GET"
                    }).then(function (response) {
                        if (response.data.error != null) {
                            alert(response.data.error.message);
                            return null;
                        }
                        $composer.units[unitName] = response.data.result;
                    });
                }
            };
            return $composer;
        }]);

        module.controller("ComposeElement", ["$scope", "$q", "$composer", function (ComposeElement, $q, $composer) {

            var makeEditor = function(element, callback) {
                // editor components
                var editor = angular.element("<input class='compose-editor' type='text' />");
                var confirm = angular.element("<i class='compose-editor confirm glyphicon glyphicon-ok'>&nbsp;</i>");
                var cancel = angular.element("<i class='compose-editor cancel glyphicon glyphicon-remove'>&nbsp;</i>");
                var wrapper = angular.element("<span class='compose-element-key-edit'>");
                wrapper.append(cancel).append(editor).append("&nbsp;&nbsp;").append(confirm);

                editor[0].value = element.html();

                // event handlers
                var exitFunc = function() {
                    wrapper.remove();
                    element.removeClass("hide");
                };

                var saveFunc = function() {
                    if (typeof callback == "function") {
                        callback(editor[0].value);
                    }
                };

                editor.on("keypress", function(e){ if(e.keyCode == 13) {
                    saveFunc();
                    exitFunc();
                }});

                confirm.on("click", saveFunc);
                confirm.on("click", exitFunc);
                cancel.on("click", exitFunc);

                // editor display
                element.addClass("hide");
                element.after(wrapper);
                editor[0].focus();
            };

            ComposeElement.init = function() {

                // back reference to itself
                ComposeElement.scope = ComposeElement;

                // extracting "data" value
                if (ComposeElement.data != undefined && typeof ComposeElement.data == "object") {
                    var fields = ["value", "path", "json", "root", "parent", "type", "label"];
                    for (var i in fields) {
                        var field = fields[i];
                        if (field in ComposeElement.data) {
                            ComposeElement[field] = ComposeElement.data[field];
                        }
                    }
                }

                // default
                ComposeElement.ready = false;

                ComposeElement.isBasic = true;
                ComposeElement.isUnit = false;

                ComposeElement.length = 0;
                ComposeElement.children = {};
                ComposeElement.info = {};

                ComposeElement.jstype = typeof ComposeElement.value;

                // root / parent
                ComposeElement.path = pathToArray(ComposeElement.path);
                if (ComposeElement.path.length == 0) {
                    ComposeElement.json = ComposeElement.value;
                    ComposeElement.root = ComposeElement;
                    ComposeElement.parent = null;
                } else {
//                    var key = ComposeElement.path.slice(-1)[0];
//                    ComposeElement.parent.children[key].scope = ComposeElement;
                }

                // value
                if (ComposeElement.value == undefined) {
                    ComposeElement.value = {};
                }

                // type
                if (typeof ComposeElement.type != "string" || ComposeElement.type == "") {
                    ComposeElement.type = typeof ComposeElement.value;
                }

                // length
                if (typeof ComposeElement.value == "object") {
                    ComposeElement.length = Object.keys(ComposeElement.value).length;
                } else if (Array.isArray(ComposeElement.value)) {
                    ComposeElement.length = ComposeElement.value.length;
                }

                // isBasic / isUnit
                if (!$composer.isBasic(ComposeElement.type)) {
                    ComposeElement.isBasic = false;
                    if ($composer.isUnit(ComposeElement.type)) {
                        ComposeElement.isUnit = true;
                        ComposeElement.info = $composer.unit(ComposeElement.type);
                    } else {
                        ComposeElement.info = $composer.type(ComposeElement.type);
                    }
                }

                // GO type request
                $q.when(ComposeElement.info).then(function (info) {
                    ComposeElement.info = info;

                    // children array
                    for (var item in ComposeElement.value) {
                        if (!ComposeElement.value.hasOwnProperty(item)) {
                            continue;
                        }

                        if (ComposeElement.info[item] == undefined) {
                            continue;
                        }

                        var itemPath = ComposeElement.path.slice();
                        itemPath.push(item);

                        ComposeElement.children[item] = {
                            path: itemPath,
                            root: ComposeElement.root,
                            json: ComposeElement.json,
                            value: ComposeElement.value[item],
                            parent: ComposeElement,

                            type: ComposeElement.info[item].type,
                            desc: ComposeElement.info[item].desc,
                            label: ComposeElement.info[item].label
                        };
                    }
                    ComposeElement.ready = true;
                });
            };

            ComposeElement.collapse = function(event) {
                var element = angular.element(event.target);
                element.toggleClass('glyphicon-triangle-right glyphicon-triangle-bottom');

                for (var i = 0; i < 10; i++) {
                    if (element.hasClass('compose-element')) {
                        element.toggleClass('minified');
                        break;
                    }
                    element = element.parent();
                }
            };

            ComposeElement.editKey = function(event, data) {
                var element = angular.element(event.target);
                makeEditor(element, function(newValue) {
                    data.label = newValue;
                    data.$apply();
                });
            };

            ComposeElement.editType = function(event, data) {
                var element = angular.element(event.target);
                makeEditor(element, function(newValue) {
                    data.type = newValue;
                    data.$apply();
                });
            };

            ComposeElement.addItem = function(event, data) {
                // var element = angular.element(event.target);
                data.json.visitor.first_name = "Evpat";
                data.json.visitor.email="123@ukr.net";
                data.root.init();
                // data.root.$apply();
                // data.root.children.visitor.scope.$digest();
                // setTimeout(function() { data.parent.$apply(); }, 1000);
            };

            ComposeElement.childValue = function(key) {
                return pathValues(ComposeElement.json, ComposeElement.path.concat(key)).slice(-1);
            };

            ComposeElement.init();
        }]);


        module.controller("DiscountEditor", ["$scope", function (DiscountEditor) {
            DiscountEditor.rule = {'visitor': {'first_name': 'test', 'last_name': '123'}};
            DiscountEditor.ruleType = "DiscountRule";
        }]);
    </script>

    <style>
        .container {
            padding: 0px 5px 0px 0px;
            background-color: #f3f6fa;
            background-image: repeating-linear-gradient(180deg, #d9edf7, #d9edf7 30px, #f5f5f5 30px, white 60px);
        }

        .compose-element {
            list-style: none;
            margin: 0;
            padding-left: 20px;
        }

        .compose-item-line {
            height: 30px;
            line-height: 30px;
        }

        .compose-item-line button {
            float: right;
            box-sizing: border-box;
            height: 30px;
            line-height: 26px;
            border-color: transparent;
            background-color: transparent;
        }

        .compose-item-line input {
            width: 100px;
            border: none;
            display: inline;
            height: 30px;
            padding: 5px;
            background-color: transparent;
        }
    </style>
</head>

<body ng-app="DiscountEditor">

<!-- template for composer item (recursive tree) -->
<ul class="compose-element" template="tpl" tpl-set="compose-element" ng-controller="ComposeElement">
    <li class="compose-item">
        <div class="compose-item-line" ng-if="ready">

            <span class="compose-item-icon" ng-switch="children.length > 0">
                <i class="glyphicon glyphicon-triangle-bottom"
                   ng-switch-when="true"
                   ng-click="collapse($event)"></i>

                <i class="glyphicon" ng-switch-default>&nbsp;</i>
            </span>

            <span class="compose-item-label">
                <b ng-click="editKey($event, scope)">{{ !label ? '""' : label }}</b>
                (<a ng-click="editType($event, scope)">{{ !type ? '""' : type }}</a>):
            </span>

            <span class="compose-item-editor" ng-switch="jstype">
                <input type="text"
                       ng-switch-when="string"
                       ng-model="value"
                       ng-change="edit(value)"/>

                <input type="number"
                       step="0.1"
                       ng-switch-when="number"
                       ng-model="value"
                       ng-change="edit(value)"/>

                <input type="checkbox"
                       ng-switch-when="boolean"
                       ng-model="value"
                       ng-change="edit(value)"/>
            </span>

            <button ng-if="parent != null" ng-click="removeItem($event, scope)">
                <i class="glyphicon glyphicon-trash"></i>
            </button>

            <button ng-if="info" ng-click="addItem($event, scope)">
                <i class="glyphicon glyphicon-plus"></i>
            </button>

            <button ng-if="hasUnits" ng-click="addUnit($event, scope)">
                <i class="glyphicon glyphicon-indent-left"></i>
            </button>
        </div>
        <template get="compose-element" data="val" ng-repeat="(key, val) in children track by childValue(key)"></template>
    </li>
</ul>

<div class="container" ng-controller="DiscountEditor">
    <template get="compose-element" value="rule" type="ruleType"></template>
</div>

</body>
</html>